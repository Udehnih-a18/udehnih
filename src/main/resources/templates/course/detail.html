<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Kursus - Udehnih</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Include navbar -->
    <div th:insert="~{navbar :: navbar}"></div>

    <div class="container mt-4">
        <a href="/courses" class="btn btn-outline-secondary mb-3">
            <i class="fas fa-arrow-left"></i> Kembali ke Daftar Kursus
        </a>

        <div id="courseDetail">
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Force check navbar status
            setTimeout(() => {
                if (window.checkLoginStatus) {
                    window.checkLoginStatus();
                }
            }, 100);
            
            const courseId = window.location.pathname.split('/').pop();
            loadCourseDetail(courseId);
        });

        function loadCourseDetail(courseId) {
            fetch(`/api/cb/courses/${courseId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Kursus tidak ditemukan');
                    }
                    return response.json();
                })
                .then(course => {
                    if (course) renderCourseDetail(course);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('courseDetail').innerHTML = 
                        '<div class="alert alert-danger">Kursus tidak ditemukan atau terjadi kesalahan</div>';
                });
        }

        function renderCourseDetail(course) {
            document.getElementById('courseDetail').innerHTML = `
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-body">
                                <h1 class="card-title">${course.name}</h1>
                                <p class="text-muted mb-3">
                                    <i class="fas fa-user"></i> Tutor: <strong>${course.tutorName}</strong>
                                </p>
                                <p class="mb-4 fs-4">
                                    <strong class="text-success">
                                        ${course.priceRp === 0 ? 'GRATIS' : `Rp ${course.priceRp.toLocaleString('id-ID')}`}
                                    </strong>
                                </p>
                                <h3>Deskripsi Kursus</h3>
                                <p class="mb-4">${course.description}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Daftar Sekarang</h5>
                                <p class="card-text">
                                    ${course.priceRp === 0 ? 
                                        '<span class="badge bg-success fs-6">GRATIS</span>' : 
                                        `<span class="fs-5 fw-bold text-success">Rp ${course.priceRp.toLocaleString('id-ID')}</span>`
                                    }
                                </p>
                                <button onclick="enrollCourse('${course.id}')" class="btn btn-success btn-lg w-100">
                                    üí∏ Daftar Kursus
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h3>üìö Isi Kursus</h3>
                                ${course.sections.length === 0 ? 
                                    '<p class="text-muted">Konten kursus belum tersedia.</p>' :
                                    course.sections.map((section, index) => `
                                        <div class="accordion-item border rounded mb-3">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" 
                                                        type="button" data-bs-toggle="collapse" 
                                                        data-bs-target="#section${index}">
                                                    <strong>Bab ${index + 1}: ${section.title}</strong>
                                                </button>
                                            </h2>
                                            <div id="section${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}">
                                                <div class="accordion-body">
                                                    <p class="text-muted mb-3">${section.description}</p>
                                                    ${section.articles.length === 0 ? 
                                                        '<p class="text-muted">Tidak ada konten.</p>' :
                                                        section.articles.map(article => `
                                                            <div class="border rounded p-3 mb-2 bg-light">
                                                                <h6 class="fw-bold">
                                                                    <i class="fas fa-${getArticleIcon(article.type)}"></i>
                                                                    ${article.title}
                                                                </h6>
                                                                <p class="mb-2">${article.description}</p>
                                                                ${article.url ? `<a href="${article.url}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                                    <i class="fas fa-external-link-alt"></i> Buka Link
                                                                </a>` : ''}
                                                                ${article.text ? `<div class="mt-2"><small class="text-muted">${article.text}</small></div>` : ''}
                                                            </div>
                                                        `).join('')
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getArticleIcon(type) {
            switch(type.toLowerCase()) {
                case 'video': return 'play-circle';
                case 'image': return 'image';
                case 'link': return 'link';
                case 'text': return 'file-text';
                default: return 'file';
            }
        }

        function enrollCourse(courseId) {
            if (!confirm('Apakah Anda yakin ingin mendaftar ke kursus ini?')) return;
            
            const token = localStorage.getItem('token');
            const headers = {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            fetch(`/api/cb/courses/${courseId}/enroll`, {
                method: 'POST',
                headers
            })
            .then(response => {
                if (response.status === 401 || response.status === 403) {
                    // Not authenticated - redirect to login
                    alert('‚ùå Anda perlu login terlebih dahulu');
                    window.location.replace('/auth/login?redirect=' + encodeURIComponent(window.location.pathname));
                    return;
                }
                if (response.ok) {
                    alert('‚úÖ Berhasil mendaftar ke kursus!');
                    window.location.href = '/my-courses';
                } else if (response.status === 400) {
                    return response.text().then(text => {
                        throw new Error(text || 'Gagal mendaftar');
                    });
                } else {
                    throw new Error('Gagal mendaftar ke kursus');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå ' + error.message);
            });
        }
    </script>

    <!-- NAVBAR SCRIPT - SAMA SEPERTI DI LIST.HTML -->
    <script>
        // Define functions immediately
        window.updateNavbar = function() {
            const token = localStorage.getItem('token');
            const guestNav = document.getElementById('guestNav');
            const userNav = document.getElementById('userNav');
            const myCourseLink = document.getElementById('myCourseLink');
            const userWelcome = document.getElementById('userWelcome');
            
            console.log('updateNavbar called - token exists:', !!token);
            
            if (token) {
                // User logged in
                if (guestNav) guestNav.style.display = 'none';
                if (userNav) userNav.style.display = 'flex';
                if (myCourseLink) myCourseLink.style.display = 'block';
                
                // Update welcome message
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const fullName = payload.fullName || payload.sub || 'User';
                    if (userWelcome) userWelcome.textContent = `üëã Hello, ${fullName}!`;
                } catch (e) {
                    if (userWelcome) userWelcome.textContent = 'üëã Hello, User!';
                }
                
                console.log('Navbar updated to logged in state');
            } else {
                // User not logged in
                if (guestNav) guestNav.style.display = 'flex';
                if (userNav) userNav.style.display = 'none';
                if (myCourseLink) myCourseLink.style.display = 'none';
                
                console.log('Navbar updated to guest state');
            }
        };

        window.logout = function() {
            localStorage.removeItem('token');
            window.updateNavbar();
            window.location.href = '/courses';
        };

        // Immediate execution when script loads
        console.log('Script loaded, starting navbar update');
        
        // Try multiple times with different delays
        setTimeout(window.updateNavbar, 100);
        setTimeout(window.updateNavbar, 500);
        setTimeout(window.updateNavbar, 1000);
        setTimeout(window.updateNavbar, 2000);
        
        // Also on window load
        window.addEventListener('load', window.updateNavbar);
        
        // And when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', window.updateNavbar);
        } else {
            window.updateNavbar();
        }
        
        console.log('Navbar update scheduled');
    </script>
</body>
</html>
