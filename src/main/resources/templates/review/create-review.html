<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buat Ulasan - Udehnih</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-teal-50 min-h-screen">
    <div th:insert="~{navbar :: navbar}"></div>

    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center mb-6">
                <button onclick="goBack()" class="text-teal-600 hover:text-teal-800 mr-4">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <h1 class="text-3xl font-bold text-gray-900">⭐ Buat Ulasan</h1>
            </div>

            <!-- Course Info Section -->
            <div id="courseInfo" class="mb-8 p-4 bg-gray-50 rounded-lg">
                <div class="animate-pulse">
                    <div class="h-6 bg-gray-300 rounded w-3/4 mb-2"></div>
                    <div class="h-4 bg-gray-300 rounded w-1/2"></div>
                </div>
            </div>

            <!-- Review Form -->
            <form id="reviewForm" class="space-y-6">
                <div>
                    <label class="block text-lg font-medium text-gray-700 mb-3">Rating Kursus</label>
                    <div class="flex items-center space-x-2 mb-2">
                        <div class="flex space-x-1" id="starRating">
                            <i class="fas fa-star text-gray-300 cursor-pointer text-3xl" data-rating="1"></i>
                            <i class="fas fa-star text-gray-300 cursor-pointer text-3xl" data-rating="2"></i>
                            <i class="fas fa-star text-gray-300 cursor-pointer text-3xl" data-rating="3"></i>
                            <i class="fas fa-star text-gray-300 cursor-pointer text-3xl" data-rating="4"></i>
                            <i class="fas fa-star text-gray-300 cursor-pointer text-3xl" data-rating="5"></i>
                        </div>
                        <span id="ratingText" class="text-gray-600 font-medium"></span>
                    </div>
                    <input type="hidden" id="ratingValue" required>
                    <p class="text-sm text-gray-500">Klik bintang untuk memberikan rating</p>
                </div>
                
                <div>
                    <label for="comment" class="block text-lg font-medium text-gray-700 mb-3">Ulasan Anda</label>
                    <textarea 
                        id="comment" 
                        rows="6" 
                        class="w-full p-4 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 text-base"
                        placeholder="Bagikan pengalaman Anda tentang kursus ini... Apa yang Anda suka? Apa yang bisa diperbaiki? Bagaimana kualitas materinya?"></textarea>
                    <p class="text-sm text-gray-500 mt-2">Ulasan yang baik membantu calon peserta lain memahami kualitas kursus</p>
                </div>
                
                <div class="flex space-x-4 pt-4">
                    <button 
                        type="submit" 
                        class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-200">
                        <i class="fas fa-paper-plane mr-2"></i>Kirim Ulasan
                    </button>
                    <button 
                        type="button" 
                        onclick="goBack()" 
                        class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-200">
                        <i class="fas fa-times mr-2"></i>Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentRating = 0;
        let courseId = null;
        let courseData = null;

        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (window.checkLoginStatus) {
                    window.checkLoginStatus();
                }
            }, 100);
            
            // Get course ID from URL
            courseId = window.location.pathname.split('/')[2];
            
            // Check authentication first
            const token = localStorage.getItem('token');
            if (!token) {
                alert('❌ Anda perlu login terlebih dahulu');
                window.location.href = '/auth/login?redirect=' + encodeURIComponent(window.location.pathname);
                return;
            }

            loadCourseInfo();
            setupStarRating();
            setupForm();
        });

        function loadCourseInfo() {
            fetch(`/api/cb/courses/${courseId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Kursus tidak ditemukan');
                    return response.json();
                })
                .then(course => {
                    courseData = course;
                    renderCourseInfo(course);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('courseInfo').innerHTML = 
                        '<div class="text-red-500 font-semibold">❌ Gagal memuat informasi kursus</div>';
                });
        }

        function renderCourseInfo(course) {
            document.getElementById('courseInfo').innerHTML = `
                <div class="flex items-start space-x-4">
                    <div class="flex-1">
                        <h3 class="text-xl font-bold text-gray-900 mb-2">${course.name}</h3>
                        <p class="text-gray-600 mb-1">
                            <i class="fas fa-user mr-2"></i>Tutor: <strong>${course.tutorName}</strong>
                        </p>
                        <p class="text-gray-600">
                            <i class="fas fa-tag mr-2"></i>
                            ${course.priceRp === 0 ? 
                                '<span class="text-teal-600 font-semibold">GRATIS</span>' : 
                                `<span class="text-teal-600 font-semibold">Rp ${course.priceRp.toLocaleString('id-ID')}</span>`
                            }
                        </p>
                    </div>
                    <a href="/courses/${course.id}" class="text-teal-600 hover:text-teal-800 text-sm">
                        <i class="fas fa-external-link-alt mr-1"></i>Lihat Detail
                    </a>
                </div>
            `;
        }

        function setupStarRating() {
            const stars = document.querySelectorAll('#starRating i');
            const ratingText = document.getElementById('ratingText');

            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    currentRating = rating;
                    document.getElementById('ratingValue').value = rating;
                    updateStarDisplay(rating);
                    updateRatingText(rating);
                });

                star.addEventListener('mouseover', function() {
                    const rating = parseInt(this.dataset.rating);
                    updateStarDisplay(rating);
                    updateRatingText(rating);
                });
            });

            document.getElementById('starRating').addEventListener('mouseleave', function() {
                updateStarDisplay(currentRating);
                updateRatingText(currentRating);
            });
        }

        function updateStarDisplay(rating) {
            const stars = document.querySelectorAll('#starRating i');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.className = 'fas fa-star text-yellow-400 cursor-pointer text-3xl';
                } else {
                    star.className = 'fas fa-star text-gray-300 cursor-pointer text-3xl';
                }
            });
        }

        function updateRatingText(rating) {
            const ratingText = document.getElementById('ratingText');
            const descriptions = {
                0: '',
                1: '⭐ Sangat Buruk',
                2: '⭐⭐ Buruk', 
                3: '⭐⭐⭐ Cukup',
                4: '⭐⭐⭐⭐ Bagus',
                5: '⭐⭐⭐⭐⭐ Sangat Bagus'
            };
            ratingText.textContent = descriptions[rating] || '';
        }

        function setupForm() {
            document.getElementById('reviewForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const rating = parseInt(document.getElementById('ratingValue').value);
                const comment = document.getElementById('comment').value.trim();

                if (!rating) {
                    alert('❌ Silakan pilih rating terlebih dahulu');
                    return;
                }

                if (rating < 1 || rating > 5) {
                    alert('❌ Rating harus antara 1-5 bintang');
                    return;
                }

                // Show loading state
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Mengirim...';
                submitBtn.disabled = true;

                const token = localStorage.getItem('token');
                
                fetch('/api/reviews', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        courseId: courseId, // Send as string UUID, not parseInt
                        rating: rating,
                        comment: comment || null
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.message || 'Gagal menyimpan ulasan');
                        });
                    }
                    return response.json();
                })
                .then(() => {
                    alert('✅ Ulasan berhasil dikirim! Terima kasih atas feedback Anda.');
                    window.location.href = '/my-reviews';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('❌ ' + error.message);
                })
                .finally(() => {
                    // Restore button state
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                });
            });
        }

        function goBack() {
            if (confirm('Apakah Anda yakin ingin membatalkan pembuatan ulasan?')) {
                history.back();
            }
        }

        // Navbar functions - removed complex implementation
    </script>
    <script th:src="@{/js/navbar.js}"></script>
</body>
</html>
