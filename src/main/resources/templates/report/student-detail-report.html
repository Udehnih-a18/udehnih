<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Udehnih - Report Detail</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-teal-50 min-h-screen">
<div th:replace="fragments/navbar :: navbar"></div>

<main class="max-w-2xl mx-auto mt-10 bg-white p-6 rounded-2xl shadow-md border border-teal-200">
    <h2 class="text-3xl font-bold text-teal-600 mb-4">Report Detail üìù</h2>
    <div id="toast" class="fixed top-4 right-4 z-50 hidden px-4 py-2 rounded shadow-md text-white text-sm"></div>
    <div id="reportDetail" class="space-y-3"></div>
</main>

<!-- Modal Edit -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-40">
    <div class="bg-white p-6 rounded-xl w-full max-w-lg shadow-lg border border-teal-200">
        <h3 class="text-xl font-semibold text-teal-800 mb-4">Edit Report</h3>
        <form id="editForm" class="space-y-4">
            <div>
                <label for="editTitle" class="block text-teal-700 font-semibold mb-1">Title</label>
                <input type="text" id="editTitle" class="w-full px-4 py-2 border border-teal-300 rounded-lg focus:ring-2 focus:ring-teal-500" />
            </div>
            <div>
                <label for="editDescription" class="block text-teal-700 font-semibold mb-1">Description</label>
                <textarea id="editDescription" class="w-full px-4 py-2 border border-teal-300 rounded-lg focus:ring-2 focus:ring-teal-500"></textarea>
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" onclick="closeModal()" class="bg-gray-200 text-teal-800 px-4 py-2 rounded-lg">Batalkan</button>
                <button type="submit" class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700">Update</button>
            </div>
            <div id="editMessage" class="text-sm mt-2"></div>
        </form>
    </div>
</div>

<!-- Modal Confirm Delete -->
<div id="confirmDeleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-xl w-full max-w-md shadow-lg border border-teal-200">
        <h3 class="text-xl font-semibold text-teal-800 mb-4">Apakah Anda yakin?</h3>
        <p class="text-gray-700 mb-4">Anda akan menghapus laporan. Aksi ini tidak bisa diulang kembali.</p>
        <div class="flex justify-end space-x-2">
            <button onclick="closeConfirmModal()" class="bg-gray-200 text-teal-800 px-4 py-2 rounded-lg">Cancel</button>
            <button onclick="confirmDeleteReport()" class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700">Ya, Hapus</button>
        </div>
    </div>
</div>

<script>
    const token = localStorage.getItem("token");
    const reportId = new URLSearchParams(window.location.search).get("id");
    const reportDetail = document.getElementById("reportDetail");
    const editModal = document.getElementById("editModal");
    const confirmDeleteModal = document.getElementById("confirmDeleteModal");
    const toast = document.getElementById("toast");

    async function loadReportDetail() {
        const res = await fetch(`/api/student/reports/${reportId}`, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        const data = await res.json();
        const report = data.report;

        reportDetail.innerHTML = `
        <h3 class="text-xl font-semibold text-teal-800">${report.title}</h3>
        <p class="text-teal-700">${report.description}</p>
        <p class="text-sm text-teal-500">Author: ${report.authorFullName}</p>
        <p class="text-sm text-teal-500">Created at: ${new Date(report.createdAt).toLocaleString()}</p>
        <p class="text-sm text-teal-500">Updated at: ${new Date(report.updatedAt).toLocaleString()}</p>
        <div class="mt-4 space-x-2">
          <button onclick="openModal('${report.title}', \`${report.description}\`);"
                  class="bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded-lg">Edit</button>
          <button onclick="openConfirmModal()"
                  class="bg-teal-700 hover:bg-teal-800 text-white px-4 py-2 rounded-lg">Delete</button>
        </div>
      `;
    }

    function openModal(title, description) {
        document.getElementById("editTitle").value = title;
        document.getElementById("editDescription").value = description;
        editModal.classList.remove("hidden");
    }

    function closeModal() {
        editModal.classList.add("hidden");
        document.getElementById("editMessage").textContent = "";
    }

    function openConfirmModal() {
        confirmDeleteModal.classList.remove("hidden");
    }

    function closeConfirmModal() {
        confirmDeleteModal.classList.add("hidden");
    }

    function showToast(message, success = true) {
        toast.textContent = message;
        toast.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded shadow-md text-white text-sm ${success ? 'bg-teal-600' : 'bg-red-600'}`;
        toast.classList.remove("hidden");
        setTimeout(() => toast.classList.add("hidden"), 3000);
    }

    document.getElementById("editForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const newTitle = document.getElementById("editTitle").value;
        const newDesc = document.getElementById("editDescription").value;

        try {
            const res = await fetch(`/api/student/reports/${reportId}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ title: newTitle, description: newDesc })
            });
            const data = await res.json();

            if (res.ok) {
                closeModal();
                showToast("‚úÖ Report updated successfully!");
                loadReportDetail();
            } else {
                document.getElementById("editMessage").textContent = `‚ö†Ô∏è ${data.message || 'Failed to update'}`;
                document.getElementById("editMessage").className = "text-red-600";
            }
        } catch (err) {
            document.getElementById("editMessage").textContent = "‚ùå Error: " + err.message;
            document.getElementById("editMessage").className = "text-red-600";
        }
    });

    async function confirmDeleteReport() {
        closeConfirmModal();

        const res = await fetch(`/api/student/reports/${reportId}`, {
            method: "DELETE",
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (res.ok) {
            showToast("‚úÖ Report deleted successfully.");
            setTimeout(() => window.location.href = "/student/reports", 1000);
        } else {
            showToast("‚ùå Failed to delete report.", false);
        }
    }

    loadReportDetail();
</script>
</body>
</html>